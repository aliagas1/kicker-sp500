name: Kicker Daily

on:
  schedule:
    # Un solo intento diario.
    # 09:35 NY = 14:35 UTC (aprox, ajusta si quieres un poco antes o después)
    - cron: "35 14 * * *"
  workflow_dispatch: {}

permissions:
  contents: write   # necesario para commitear resultados al repo

concurrency:
  group: kicker-daily
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      # Config para detector.py
      USE_PREPOST: "true"              # Intenta prepost=true
      FALLBACK_QUASI_KICKER: "true"    # Si no hay pre/post, usa 09:30
      UNIVERSE_MAX: "350"              # Limitar universo para no pasarnos de los ~800/día
      MAX_PER_MINUTE: "0"              # 0 = desactivar límite por minuto (lo controla Twelve Data)
      MAX_PER_DAY: "780"               # Seguridad para no sobrepasar el límite diario

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install -r requirements.txt

      - name: Ejecutar detector
        env:
          TWELVEDATA_API_KEY: ${{ secrets.TWELVEDATA_API_KEY }}
          # Hereda también las env definidas en jobs.run.env (USE_PREPOST, etc.)
        run: python detector.py

      - name: Commit y push de results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add results/*.json results/diagnostics-*.jsonl || true

          # Evita commits vacíos
          git diff --cached --quiet || git commit -m "Resultados Kicker $(date -u +'%Y-%m-%dT%H:%MZ')"

          # Rebase para evitar el error de "fetch first"
          git pull --rebase origin main || true
          git push origin main || true
